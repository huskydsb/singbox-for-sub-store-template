https://raw.githubusercontent.com/huskydsb/singbox-for-sub-store-template/main/template.js#type=å•æ¡è®¢é˜…&name=æœºåœº&outbound=ğŸ•³â„¹ï¸ğŸš€èŠ‚ç‚¹é€‰æ‹©|ğŸˆè‡ªåŠ¨é€‰æ‹©ğŸ•³â„¹ï¸ğŸ‡­ğŸ‡°é¦™æ¸¯æ‰‹åŠ¨|ğŸ‡­ğŸ‡°é¦™æ¸¯è‡ªåŠ¨ğŸ·â„¹ï¸Hong Kong|HK|é¦™æ¸¯|Hong Kong Island|é¦™æ¸¯å²›|Kowloon|ä¹é¾™|New Territories|æ–°ç•Œ|Central|ä¸­ç¯|Wan Chai|æ¹¾ä»”|Causeway Bay|é“œé”£æ¹¾|Tsim Sha Tsui|å°–æ²™å’€|Mong Kok|æ—ºè§’|Yau Ma Tei|æ²¹éº»åœ°|Jordan|ä½æ•¦|Shatin|æ²™ç”°|Tai Po|å¤§åŸ”|Tsuen Wan|èƒæ¹¾|Kwai Chung|è‘µæ¶Œ|Lantau Island|å¤§å±¿å±±|Discovery Bay|æ„‰æ™¯æ¹¾|Sai Kung|è¥¿è´¡|Cheung Chau|é•¿æ´²|Peng Chau|åªæ´²|Ma On Shan|é©¬éå±±|Kowloon Tong|ä¹é¾™å¡˜|ğŸ‡­ğŸ‡°ğŸ•³â„¹ï¸ğŸ‡¹ğŸ‡¼å°æ¹¾æ‰‹åŠ¨|ğŸ‡¹ğŸ‡¼å°æ¹¾è‡ªåŠ¨ğŸ·â„¹ï¸Taiwan|TW|å°åŒ—å¸‚|Taipei|å°åŒ—|æ–°åŒ—å¸‚|New Taipei|æ–°åŒ—|æ¡ƒå›­å¸‚|Taoyuan|æ¡ƒå›­|å°ä¸­å¸‚|Taichung|å°ä¸­|å°å—å¸‚|Tainan|å°å—|é«˜é›„å¸‚|Kaohsiung|é«˜é›„|åŸºéš†å¸‚|Keelung|åŸºéš†|æ–°ç«¹å¸‚|Hsinchu|æ–°ç«¹|å˜‰ä¹‰å¸‚|Chiayi|å˜‰ä¹‰|å®œå…°å¿|Yilan|å®œå…°|èŠ±è²å¿|Hualien|èŠ±è²|å°ä¸œå¿|Taitung|å°ä¸œ|å—æŠ•å¿|Nantou|å—æŠ•|å±ä¸œå¿|Pingtung|å±ä¸œ|å½°åŒ–å¿|Changhua|å½°åŒ–|äº‘æ—å¿|Yunlin|äº‘æ—|è‹—æ —å¿|Miaoli|è‹—æ —|ä¸­å’Œ|Zhonghe|ä¸‰å³¡|Sanxia|åœŸåŸ|Tucheng|æ·¡æ°´|Danshui|æ°¸å’Œ|Yonghe|æ¿æ¡¥|Banqiao|æ—å£|Linkou|å…³æ¸¡|Guandu|æ¾å±±|Songshan|å’Œå¹³|Heping|ğŸ‡¹ğŸ‡¼ğŸ•³â„¹ï¸ğŸ‡¯ğŸ‡µæ—¥æœ¬æ‰‹åŠ¨|ğŸ‡¯ğŸ‡µæ—¥æœ¬è‡ªåŠ¨ğŸ·â„¹ï¸Japan|æ—¥æœ¬|Hokkaido|åŒ—æµ·é“|Aomori|é’æ£®|Iwate|å²©æ‰‹|Miyagi|å®«åŸ|Akita|ç§‹ç”°|Yamagata|å±±å½¢|Fukushima|ç¦å²›|Ibaraki|èŒ¨åŸ|Tochigi|æ¥æœ¨|Gunma|ç¾¤é©¬|Saitama|åŸ¼ç‰|Chiba|åƒå¶|Tokyo|ä¸œäº¬|Kanagawa|ç¥å¥ˆå·|Niigata|æ–°æ½Ÿ|Toyama|å¯Œå±±|Ishikawa|çŸ³å·|Fukui|ç¦äº•|Yamanashi|å±±æ¢¨|Nagano|é•¿é‡|Gifu|å²é˜œ|Shizuoka|é™å†ˆ|Aichi|çˆ±çŸ¥|Mie|ä¸‰é‡|Shiga|æ»‹è´º|Kyoto|äº¬éƒ½|Osaka|å¤§é˜ª|Hyogo|å…µåº“|Nara|å¥ˆè‰¯|Wakayama|å’Œæ­Œå±±|Tottori|é¸Ÿå–|Shimane|å²›æ ¹|Okayama|å†ˆå±±|Hiroshima|å¹¿å²›|Yamaguchi|å±±å£|Tokushima|å¾·å²›|Kagawa|é¦™å·|Ehime|çˆ±åª›|Kochi|é«˜çŸ¥|Fukuoka|ç¦å†ˆ|Saga|ä½è´º|Nagasaki|é•¿å´|Kumamoto|ç†Šæœ¬|Oita|å¤§åˆ†|Miyazaki|å®«å´|Kagoshima|é¹¿å„¿å²›|Okinawa|å†²ç»³|Sapporo|æœ­å¹Œ|Sendai|ä»™å°|Yokohama|æ¨ªæ»¨|Nagoya|åå¤å±‹|Kobe|ç¥æˆ·|Hiroshima|å¹¿å²›|Fukuoka|ç¦å†ˆ|Kawasaki|å·å´|Saitama|åŸ¼ç‰|Chiba|åƒå¶|Kitakyushu|åŒ—ä¹å·|Sakai|å ºå¸‚|Niigata|æ–°æ½Ÿ|Hamamatsu|æ»¨æ¾|Shizuoka|é™å†ˆ|Okayama|å†ˆå±±|Kumamoto|ç†Šæœ¬|Sagamihara|ç›¸æ¨¡åŸ|Hachioji|å…«ç‹å­|Himeji|å§¬è·¯|Matsuyama|æ¾å±±|Kanazawa|é‡‘æ³½|Nagasaki|é•¿å´|Okinawa|å†²ç»³|ğŸ‡¯ğŸ‡µğŸ•³â„¹ï¸ğŸ‡¸ğŸ‡¬ç‹®åŸæ‰‹åŠ¨|ğŸ‡¸ğŸ‡¬ç‹®åŸè‡ªåŠ¨ğŸ·â„¹ï¸^(?!.*(?:us)).*(Singapore|SG|æ–°åŠ å¡|ç‹®åŸ|ç‹®åŸå²›|Lion City|Garden City|æ–°åŠ å¡å¸‚|Singapore City|Bedok|è´å¤šå…‹|Bukit Batok|æ­¦å‰å·´ç£|Bukit Panjang|æ­¦å‰ç­è®©|Choa Chu Kang|è”¡åæ¸¯|Clementi|å…‹å…°èŠ|Downtown Core|å¸‚ä¸­å¿ƒæ ¸å¿ƒåŒº|Jurong East|è£•å»Šä¸œ|Jurong West|è£•å»Šè¥¿|Kallang|åŠ å†·|Novena|è¯ºç»´çº³|Orchard|ä¹ŒèŠ‚|Pasir Ris|å·´è¥¿ç‘æ–¯|Punggol|æ¦œé¹…|Sengkang|ç››æ¸¯|Tampines|æ·¡æ»¨å°¼|Toa Payoh|å¤§å·´çª‘|Woodlands|å…€å…°|Yishun|ä¹‰é¡º|ğŸ‡¸ğŸ‡¬)ğŸ•³â„¹ï¸ğŸ‡°ğŸ‡·éŸ©å›½æ‰‹åŠ¨|ğŸ‡°ğŸ‡·éŸ©å›½è‡ªåŠ¨ğŸ·â„¹ï¸South Korea|Korea|KR|Republic of Korea|ROK|éŸ©å›½|ì„œìš¸|Seoul|é‡œå±±|Busan|å¤§é‚±|Daegu|ä»å·|Incheon|å…‰å·|Gwangju|å¤§ç”°|Daejeon|è”šå±±|Ulsan|æ°´åŸ|Suwon|æ˜ŒåŸ|Changwon|åŸå—|Seongnam|é«˜é˜³|Goyang|é¾™ä»|Yongin|å¯Œå·|Bucheon|å®‰å…»|Anyang|å¤©å®‰|Cheonan|å…¨å·|Jeonju|æ˜¥å·|Chuncheon|æ¸…å·|Cheongju|é‡‘æµ·|Gimhae|å…‰æ˜|Gwangmyeong|é‡‘æµ¦|Gimpo|ç‰™å±±|Asan|åŸå·|Wonju|è”šå·|Uijeongbu|å…¬å·|Gongju|ç¾¤å±±|Gunsan|å—åŸ|Namwon|å®œå®|Eumseong|é©ªå·|Yeoju|ä¸‰é™Ÿ|Samcheok|ä¸œæµ·|Donghae|æŸè‰|Sokcho|æµå·|Jeju|ğŸ‡°ğŸ‡·ğŸ•³â„¹ï¸ğŸ‡ºğŸ‡¸ç¾å›½æ‰‹åŠ¨|ğŸ‡ºğŸ‡¸ç¾å›½è‡ªåŠ¨ğŸ·â„¹ï¸USA|United States|America|US|ç¾å›½|é˜¿æ‹‰å·´é©¬å·|é˜¿æ‹‰æ–¯åŠ å·|äºšåˆ©æ¡‘é‚£å·|é˜¿è‚¯è‰²å·|åŠ åˆ©ç¦å°¼äºšå·|ç§‘ç½—æ‹‰å¤šå·|åº·æ¶…ç‹„æ ¼å·|ç‰¹æ‹‰åå·|ä½›ç½—é‡Œè¾¾å·|ä¹”æ²»äºšå·|å¤å¨å¤·å·|çˆ±è¾¾è·å·|ä¼Šåˆ©è¯ºä¼Šå·|å°ç¬¬å®‰çº³å·|çˆ±è·åå·|å ªè¨æ–¯å·|è‚¯å¡”åŸºå·|è·¯æ˜“æ–¯å®‰é‚£å·|ç¼…å› å·|é©¬é‡Œå…°å·|é©¬è¨è¯¸å¡å·|å¯†æ­‡æ ¹å·|æ˜å°¼è‹è¾¾å·|å¯†è¥¿è¥¿æ¯”å·|å¯†è‹é‡Œå·|è’™å¤§æ‹¿å·|å†…å¸ƒæ‹‰æ–¯åŠ å·|å†…åè¾¾å·|æ–°ç½•å¸ƒä»€å°”å·|æ–°æ³½è¥¿å·|æ–°å¢¨è¥¿å“¥å·|çº½çº¦å·|åŒ—å¡ç½—æ¥çº³å·|åŒ—è¾¾ç§‘ä»–å·|ä¿„äº¥ä¿„å·|ä¿„å…‹æ‹‰è·é©¬å·|ä¿„å‹’å†ˆå·|å®¾å¤•æ³•å°¼äºšå·|ç½—å¾—å²›å·|å—å¡ç½—æ¥çº³å·|å—è¾¾ç§‘ä»–å·|ç”°çº³è¥¿å·|å¾·å…‹è¨æ–¯å·|çŠ¹ä»–å·|ä½›è’™ç‰¹å·|å¼—å‰å°¼äºšå·|åç››é¡¿å·|è¥¿å¼—å‰å°¼äºšå·|å¨æ–¯åº·æ˜Ÿå·|æ€€ä¿„æ˜å·|New York City|çº½çº¦å¸‚|Los Angeles|æ´›æ‰çŸ¶|Chicago|èŠåŠ å“¥|Houston|ä¼‘æ–¯é¡¿|Phoenix|è²å°¼å…‹æ–¯|Philadelphia|è´¹åŸ|San Antonio|åœ£å®‰ä¸œå°¼å¥¥|San Diego|åœ£è¿­æˆˆ|Dallas|è¾¾æ‹‰æ–¯|San Jose|åœ£ä½•å¡|Austin|å¥¥æ–¯æ±€|Jacksonville|æ°å…‹é€Šç»´å°”|Fort Worth|æ²ƒæ–¯å ¡|Columbus|å“¥ä¼¦å¸ƒ|Charlotte|å¤æ´›ç‰¹|San Francisco|æ—§é‡‘å±±|Indianapolis|å°ç¬¬å®‰çº³æ³¢åˆ©æ–¯|Seattle|è¥¿é›…å›¾|Denver|ä¸¹ä½›|Washington|åç››é¡¿|Boston|æ³¢å£«é¡¿|El Paso|åŸƒå°”å¸•ç´¢|Detroit|åº•ç‰¹å¾‹|Nashville|çº³ä»€ç»´å°”|Portland|æ³¢ç‰¹å…°|Memphis|å­Ÿè²æ–¯|Oklahoma City|ä¿„å…‹æ‹‰è·é©¬åŸ|Las Vegas|æ‹‰æ–¯ç»´åŠ æ–¯|Louisville|è·¯æ˜“æ–¯ç»´å°”|Baltimore|å·´å°”çš„æ‘©|Milwaukee|å¯†å°”æ²ƒåŸº|Albuquerque|é˜¿å°”ä¼¯å…‹åŸº|Tucson|å›¾æ£®|Fresno|å¼—é›·æ–¯è¯º|Sacramento|è¨å…‹æ‹‰é—¨æ‰˜|Kansas City|å ªè¨æ–¯åŸ|Long Beach|é•¿æ»©|Mesa|æ¢…è¨|Atlanta|äºšç‰¹å…°å¤§|Colorado Springs|ç§‘ç½—æ‹‰å¤šæ–¯æ™®æ—æ–¯|Virginia Beach|å¼—å‰å°¼äºšæµ·æ»©|Raleigh|ç½—åˆ©|Omaha|å¥¥é©¬å“ˆ|Miami|è¿ˆé˜¿å¯†|Oakland|å¥¥å…‹å…°|Minneapolis|æ˜å°¼é˜¿æ³¢åˆ©æ–¯|Tulsa|å¡”å°”è¨|Wichita|å¨å¥‡æ‰˜|New Orleans|æ–°å¥¥å°”è‰¯|ğŸ‡ºğŸ‡¸


// ç¤ºä¾‹è¯´æ˜
// è¯»å– åç§°ä¸º "æœºåœº" çš„ ç»„åˆè®¢é˜… ä¸­çš„èŠ‚ç‚¹(å•è®¢é˜…ä¸éœ€è¦è®¾ç½® type å‚æ•°)
// æŠŠ æ‰€æœ‰èŠ‚ç‚¹æ’å…¥åŒ¹é… /all|all-auto/i çš„ outbound ä¸­(è·Ÿåœ¨ ğŸ•³ åé¢, â„¹ï¸ è¡¨ç¤ºå¿½ç•¥å¤§å°å†™, ä¸ç­›é€‰èŠ‚ç‚¹ä¸éœ€è¦ç»™ ğŸ· )
// æŠŠåŒ¹é… /æ¸¯|hk|hongkong|kong kong|ğŸ‡­ğŸ‡°/i  (è·Ÿåœ¨ ğŸ· åé¢, â„¹ï¸ è¡¨ç¤ºå¿½ç•¥å¤§å°å†™) çš„èŠ‚ç‚¹æ’å…¥åŒ¹é… /hk|hk-auto/i çš„ outbound ä¸­
// ...
// å¯é€‰å‚æ•°: includeUnsupportedProxy åŒ…å«å®˜æ–¹/å•†åº—ç‰ˆä¸æ”¯æŒçš„åè®® SSR. ç”¨æ³•: `&includeUnsupportedProxy=true`

// âš ï¸ å¦‚æœ outbounds ä¸ºç©º, è‡ªåŠ¨åˆ›å»º COMPATIBLE(direct) å¹¶æ’å…¥ é˜²æ­¢æŠ¥é”™
log(`ğŸš€ å¼€å§‹`)

let { type, name, outbound, includeUnsupportedProxy } = $arguments

log(`ä¼ å…¥å‚æ•° type: ${type}, name: ${name}, outbound: ${outbound}`)

type = /^1$|col|ç»„åˆ/i.test(type) ? 'collection' : 'subscription'

log(`â‘  è§£æé…ç½®æ–‡ä»¶`)
let config
try {
  config = JSON.parse($content ?? $files[0])
} catch (e) {
  log(`${e.message ?? e}`)
  throw new Error('é…ç½®æ–‡ä»¶ä¸æ˜¯åˆæ³•çš„ JSON')
}
log(`â‘¡ è·å–è®¢é˜…`)
log(`å°†è¯»å–åç§°ä¸º ${name} çš„ ${type === 'collection' ? 'ç»„åˆ' : ''}è®¢é˜…`)
let proxies = await produceArtifact({
  name,
  type,
  platform: 'sing-box',
  produceType: 'internal',
  produceOpts: {
    'include-unsupported-proxy': includeUnsupportedProxy,
  },
})
log(`â‘¢ outbound è§„åˆ™è§£æ`)
const outbounds = outbound
  ã€‚split('ğŸ•³')
  ã€‚filter(i => i)
  ã€‚map(i => {
    let [outboundPattern, tagPattern = '.*'] = i.split('ğŸ·')
    const tagRegex = createTagRegExp(tagPattern)
    log(`åŒ¹é… ğŸ· ${tagRegex} çš„èŠ‚ç‚¹å°†æ’å…¥åŒ¹é… ğŸ•³ ${createOutboundRegExp(outboundPattern)} çš„ outbound ä¸­`)
    return [outboundPattern, tagRegex]
  })

log(`â‘£ outbound æ’å…¥èŠ‚ç‚¹`)
config.outbounds.map(outbound => {
  outbounds.map(([outboundPattern, tagRegex]) => {
    const outboundRegex = createOutboundRegExp(outboundPattern)
    if (outboundRegex.test(outbound.tag)) {
      if (!Array.isArray(outbound.outbounds)) {
        outbound.outbounds = []
      }
      const tags = getTags(proxies, tagRegex)
      log(`ğŸ•³ ${outbound.tag} åŒ¹é… ${outboundRegex}, æ’å…¥ ${tags.length} ä¸ª ğŸ· åŒ¹é… ${tagRegex} çš„èŠ‚ç‚¹`)
      outbound.outbounds.push(...tags)
    }
  })
})

const compatible_outbound = {
  tag: 'COMPATIBLE',
  type: 'direct',
}

let compatible
log(`â‘¤ ç©º outbounds æ£€æŸ¥`)
config.outbounds.map(outbound => {
  outbounds.map(([outboundPattern, tagRegex]) => {
    const outboundRegex = createOutboundRegExp(outboundPattern)
    if (outboundRegex.test(outbound.tag)) {
      if (!Array.isArray(outbound.outbounds)) {
        outbound.outbounds = []
      }
      if (outbound.outbounds.length === 0) {
        if (!compatible) {
          config.outbounds.push(compatible_outbound)
          compatible = true
        }
        log(`ğŸ•³ ${outbound.tag} çš„ outbounds ä¸ºç©º, è‡ªåŠ¨æ’å…¥ COMPATIBLE(direct)`)
        outbound.outbounds.push(compatible_outbound.tag)
      }
    }
  })
})

config.outbounds.push(...proxies)

$content = JSON.stringify(config, null, 2)

function getTags(proxies, regex) {
  return (regex ? proxies.filter(p => regex.test(p.tag)) : proxies).map(p => p.tag)
}
function log(v) {
  console.log(`[ğŸ“¦ sing-box æ¨¡æ¿è„šæœ¬] ${v}`)
}
function createTagRegExp(tagPattern) {
  return new RegExp(tagPattern.replace('â„¹ï¸', ''), tagPattern.includes('â„¹ï¸') ? 'i' : undefined)
}
function createOutboundRegExp(outboundPattern) {
  return new RegExp(outboundPattern.replace('â„¹ï¸', ''), outboundPattern.includes('â„¹ï¸') ? 'i' : undefined)
}

log(`ğŸ”š ç»“æŸ`)
